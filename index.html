<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نظام المخزون الكامل</title>
<style>
body { font-family: sans-serif; background:#f3f3f3; }
.card { background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px #ddd; max-width:900px; margin:20px auto;}
input,select,button { padding:10px; margin:5px 0; font-size:16px; width:100%;}
button { background:#2196f3; color:white; border:none; border-radius:6px; cursor:pointer;}
button:hover{background:#1769aa;}
table{width:100%; border-collapse:collapse;}
th,td{border:1px solid #ccc; padding:8px; text-align:center;}
.success{color:green; font-weight:bold;}
.error{color:red; font-weight:bold;}
.alert{color:red;font-weight:bold;}
</style>
</head>
<body>

<div class="card" id="loginDiv">
<h2>تسجيل الدخول</h2>
<input id="username" placeholder="اسم المستخدم">
<input id="password" placeholder="كلمة المرور" type="password">
<button onclick="login()">دخول</button>
<p id="loginResult"></p>
</div>

<div id="dashboardDiv" style="display:none;">
<h2>لوحة التحكم</h2>
<p>مرحبًا <span id="roleName"></span></p>

<div class="card">
<h3>المخزون الحالي</h3>
<table id="inventoryTable">
<tr><th>الصنف</th><th>الفئة</th><th>الكمية</th><th>تنبيه</th></tr>
</table>
</div>

<div class="card">
<h3>إضافة طلب/صرف</h3>
<label>الصنف</label><input id="item" placeholder="مثال: سكر – شاي – مسحوق تنظيف">
<label>الكمية</label><input type="number" id="qty">
<label>الفئة (لصنف جديد)</label><input id="category" placeholder="مثال: بوفيه – مشروبات – مواد تنظيف">
<label>حد التنبيه (لصنف جديد)</label><input id="low_alert" type="number" placeholder="مثال: 5">
<label>الموافق</label>
<select id="approver">
<option>HR</option><option>Store</option>
</select>
<button onclick="createRequest()">إرسال الطلب</button>
<p id="resultReq"></p>
</div>

<div class="card">
<h3>الموافقة على الطلبات</h3>
<table id="requestsTable">
<tr><th>ID</th><th>الصنف</th><th>الكمية</th><th>المرسل</th><th>الموافق</th><th>إجراء</th></tr>
</table>
</div>
</div>

<script>
const API = "PUT-YOUR-APPSCRIPT-URL-HERE"; // ضع هنا رابط Google Apps Script
let currentRole = "";

// تسجيل دخول
async function login(){
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  const res = await fetch(API,{method:"POST", body:JSON.stringify({action:"login", username,password})});
  const data = await res.json();
  if(data.success){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("dashboardDiv").style.display="block";
    document.getElementById("roleName").innerText = data.role;
    currentRole = data.role;
    loadInventory();
    loadRequests();
  }else{
    document.getElementById("loginResult").innerHTML="<span class='error'>اسم المستخدم أو كلمة المرور خاطئة</span>";
  }
}

// تحميل المخزون الحالي مع تنبيهات
async function loadInventory(){
  const res = await fetch(API,{method:"POST", body:JSON.stringify({action:"get_inventory"})});
  const data = await res.json();
  if(data.success){
    const table = document.getElementById("inventoryTable");
    table.innerHTML="<tr><th>الصنف</th><th>الفئة</th><th>الكمية</th><th>تنبيه</th></tr>";
    data.inventory.forEach(row=>{
      let alert = (row[2]<=row[3])? "<span class='alert'>نقص</span>":"";
      table.innerHTML+="<tr><td>"+row[0]+"</td><td>"+row[1]+"</td><td>"+row[2]+"</td><td>"+alert+"</td></tr>";
    });
  }
}

// إنشاء طلب جديد
async function createRequest(){
  const item = document.getElementById("item").value;
  const qty = parseInt(document.getElementById("qty").value);
  const approver = document.getElementById("approver").value;
  const category = document.getElementById("category").value || "عام";
  const low_alert = parseInt(document.getElementById("low_alert").value) || 5;

  if(!item || !qty){ document.getElementById("resultReq").innerHTML="<span class='error'>اكمل البيانات</span>"; return;}

  const res = await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      action:"create_request",
      item,
      quantity: qty,
      sender: currentRole,
      approver,
      category,
      low_alert
    })
  });

  const data = await res.json();
  if(data.success){
    document.getElementById("resultReq").innerHTML="<span class='success'>تم إرسال الطلب</span>";
    loadRequests();
  }
}

// تحميل الطلبات المعلقة
async function loadRequests(){
  const res = await fetch(API,{method:"POST",body:JSON.stringify({action:"get_requests"})});
  const data = await res.json();
  const table = document.getElementById("requestsTable");
  table.innerHTML="<tr><th>ID</th><th>الصنف</th><th>الكمية</th><th>المرسل</th><th>الموافق</th><th>إجراء</th></tr>";
  if(data.success){
    data.requests.forEach(row=>{
      let btn = "";
      if(row[5]===currentRole){
        btn = "<button onclick='approve("+row[0]+")'>موافقة</button>";
      }
      table.innerHTML+="<tr><td>"+row[0]+"</td><td>"+row[1]+"</td><td>"+row[2]+"</td><td>"+row[3]+"</td><td>"+row[5]+"</td><td>"+btn+"</td></tr>";
    });
  }
}

// الموافقة على الطلب وخصم تلقائي / إنشاء صف جديد إذا الصنف جديد
async function approve(id){
  const res = await fetch(API,{method:"POST", body:JSON.stringify({action:"approve", id, approved_by:currentRole})});
  const data = await res.json();
  if(data.success){
    alert("تمت الموافقة والخصم التلقائي من المخزون");
    loadInventory();
    loadRequests();
  }else{
    alert("تعذر العثور على الطلب");
  }
}
</script>
</body>
</html>
